@page "/planner/schedule"
@attribute [Authorize]
@using Drogecode.Knrm.Oefenrooster.Client.Pages.Planner.Components
@using Drogecode.Knrm.Oefenrooster.Client.Repositories;
@using Drogecode.Knrm.Oefenrooster.Shared.Models.Schedule;

@if (_functions != null && _users != null && _userTrainingCounter != null)
{
    <MudPaper>
        <MudList Clickable="false">
            <MudDivider />
            @foreach (var function in _functions.OrderBy(x => x.Order))
            {
                @foreach (var user in _userTrainingCounter)
                {
                    var dbUser = _users.FirstOrDefault(x => x.Id == user.UserId && x.UserFunctionId == function.Id);
                    @if (dbUser != null)
                    {
                        <MudListItem Style="@(function.TrainingTarget > user.Count ? "color: var(--mud-palette-error-lighten)" : "")" Text=@($"{dbUser.Name} : {@user.Count}") />
                    }
                }
            }
            @foreach (var function in _functions.Where(x => x.TrainingTarget > 0).OrderBy(x => x.Order))
            {
                @foreach (var user in _users.Where(x => x.UserFunctionId == function.Id && !_userTrainingCounter.Any(y => y.UserId == x.Id)).OrderBy(x=>x.Name))
                {
                    <MudListItem Style="color: var(--mud-palette-error)" Text=@($"{user.Name} : {L["No training"]}") />
                }
            }
        </MudList>
    </MudPaper>
}

<MudCalendar Items="_events" MonthCellMinHeight="100" DateRangeChanged="SetCalenderForMonth" Outlined ButtonVariant="Variant.Text" ShowDay=false ShowWeek=false>
    <CellTemplate>
        @{
            var training = ((CustomItem)context).Training;
        }
        @if (training != null)
        {
            <ScheduleCard Planner="training" Users="_users" Functions="_functions" Vehicles="_vehicles" TrainingTypes="_trainingTypes" />
        }
    </CellTemplate>
</MudCalendar>