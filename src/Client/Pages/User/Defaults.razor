@page "/user/defaults"
@attribute [Authorize]
@using Drogecode.Knrm.Oefenrooster.Shared.Enums;
@using Drogecode.Knrm.Oefenrooster.Shared.Models.DefaultSchedule;
<PageTitle>@L["Default schedule"]</PageTitle>

@if (_defaultSchedules is not null)
{
    <MudDataGrid Items="@_defaultSchedules.OrderBy(x=> x.Order).ThenBy(x=>x.TimeStart)" Context="outerContext">
        <Columns>
            <HierarchyColumn T="DefaultSchedule" />
            <PropertyColumn Property="x => x.WeekDay" Title="@L["Weekday"]">
                <CellTemplate>
                    @LApp[context.Item.WeekDay.ToString() ?? "None"]
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.TimeStart" Title="@L["TimeStart"]" />
            <PropertyColumn Property="x => x.TimeEnd" Title="@L["TimeEnd"]" />
            <TemplateColumn Title="@L["Current setting"]" Context="outerContext">
                <CellTemplate>
                    @LApp[outerContext.Item.UserSchedules?.FirstOrDefault()?.Available.ToString() ?? ""]
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <ChildRowContent>
            @if (outerContext.Item?.UserSchedules is not null && outerContext.Item.UserSchedules.Count > 0)
            {
                List<DefaultUserSchedule> copy = outerContext.Item.UserSchedules.DeepCloon();
                copy.First().Assigned = true;
                <MudDataGrid T="DefaultUserSchedule" Items="@copy" Context="innerContext" EditMode="DataGridEditMode.Form" EditTrigger="@DataGridEditTrigger.Manual"
                             StartedEditingItem="@StartedEditingItem" CanceledEditingItem="@CanceledEditingItem" CommittedItemChanges="@CommittedItemChanges"
                             ReadOnly="false" Bordered="true" Dense="true">
                    <Columns>
                        <PropertyColumn Property="x => x.ValidFromUser" Title="@L["ValidFrom"]" />
                        <PropertyColumn Property="x => x.ValidUntilUser" Title="@L["ValidUntil"]" />
                        <PropertyColumn Property="x => x.Available" Title="@L["Availability"]" Context="innerContext">
                            <CellTemplate>
                                @LApp[innerContext.Item.Available.ToString() ?? "None"]
                            </CellTemplate>
                        </PropertyColumn>
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
                foreach (var schedule in outerContext.Item.UserSchedules)
                {
                    <MudText>@LApp[schedule.Available.ToString() ?? "None"] - @schedule.Assigned</MudText>
                    <br />
                }
                <MudExpansionPanels Style="flex:1">
                    <MudExpansionPanel Text="Show Events">
                        @foreach (var message in _events)
                        {
                            <MudText Typo="@Typo.body2">@message</MudText>
                        }
                        @if (_events.Count > 0)
                        {
                            <div class="d-flex">
                                <MudSpacer />
                                <MudButton Class="mt-3" ButtonType="ButtonType.Button" Variant="Variant.Filled" OnClick="@(() => _events.Clear())">Clear</MudButton>
                            </div>
                        }
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
            else
            {
                <MudText>No default configuration</MudText>
            }
            @* <MudCard>
        <MudCardHeader>
        <CardHeaderContent>
        <MudText Typo="Typo.h6">@L["Configure your default availabilty here"]</MudText>
        </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
        <MudSelect T="Availabilty?" Variant="Variant.Text" @bind-Value="context.Item.Available" SelectedValuesChanged="()=>OnChange(context.Item)" AdornmentColor="@PlannerHelper.ColorAvailabilty(context.Item.Available)">
        <MudSelectItem T="Availabilty?" Value="Availabilty.None">@LApp["None"]</MudSelectItem>
        <MudSelectItem T="Availabilty?" Value="Availabilty.Available">@LApp["Available"]</MudSelectItem>
        <MudSelectItem T="Availabilty?" Value="Availabilty.NotAvailable">@LApp["NotAvailable"]</MudSelectItem>
        <MudSelectItem T="Availabilty?" Value="Availabilty.Maybe">@LApp["Maybe"]</MudSelectItem>
        </MudSelect>
        </MudCardContent>
        </MudCard> *@
        </ChildRowContent>
    </MudDataGrid>
}
else
{
    <MudSkeleton />
    <MudSkeleton />
    <MudSkeleton />
    <MudSkeleton />
}